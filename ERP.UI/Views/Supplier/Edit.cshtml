@model SupplierModel
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>表单组合</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link href="~/LayUI/layuiAdmin/layuiadmin/layui/css/layui.css" rel="stylesheet" />
    <link href="~/LayUI/layuiAdmin/layuiadmin/style/admin.css" rel="stylesheet" />
    <style type="text/css">
        .supplier .layui-form-label {
            width: 84px;
        }
    </style>
</head>
<body>

    <div class="layui-fluid">
        <div class="layui-card">
            <div class="layui-card-header">表单组合</div>
            <div class="layui-card-body" style="padding: 15px;">
                <form class="layui-form" action="" lay-filter="component-form-group">
                    <div class="layui-form-item supplier">
                        <div class="layui-inline">
                            <label class="layui-form-label">
                                供应商等级：
                            </label>
                            <div class="layui-input-inline">
                                <select id="SupplierLevel" name="SupplierLevel">
                                    <option value="">--请选择--</option>
                                    @foreach (var item in (ViewBag.dict as IEnumerable<DictModel>).Where(m => m.DictType == 1))
                                    {
                                        <option value="@item.DictName" @Html.Raw(item.DictName == Model.SupplierLevel ? "selected=\"selected\"" : "")>@item.DictName</option>
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">供应商名称：</label>
                            <div class="layui-input-inline">
                                @Html.TextBoxFor(m => m.SupplierName, new { autocomplete = "off", @class = "layui-input" })
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">联系人：</label>
                            <div class="layui-input-inline">
                                @Html.TextBoxFor(m => m.Contact, new { autocomplete = "off", @class = "layui-input" })
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item supplier">
                        <div class="layui-inline">
                            <label class="layui-form-label">
                                联系电话：
                            </label>
                            <div class="layui-input-inline">
                                @Html.TextBoxFor(m => m.TEL, new { autocomplete = "off", @class = "layui-input" })
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">手机号：</label>
                            <div class="layui-input-inline">
                                @Html.TextBoxFor(m => m.Phone, new { autocomplete = "off", @class = "layui-input" })
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">供应商状态：</label>
                            <div class="layui-input-inline">
                                <select id="Status" name="Status">
                                    <option value="">--请选择--</option>
                                    @foreach (var item in (ViewBag.dict as IEnumerable<DictModel>).Where(m => m.DictType == 2))
                                    {
                                        <option value="@item.DictName" @Html.Raw(item.DictName == Model.Status ? "selected=\"selected\"" : "")>@item.DictName</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item supplier">
                        <div class="layui-inline">
                            <label class="layui-form-label">付款类型：</label>
                            <div class="layui-input-inline">
                                <select id="PayType" name="PayType">
                                    <option value="">--请选择--</option>
                                    @foreach (var item in (ViewBag.dict as IEnumerable<DictModel>).Where(m => m.DictType == 3))
                                    {
                                        <option value="@item.DictName" @Html.Raw(item.DictName == Model.PayType ? "selected=\"selected\"" : "")>@item.DictName</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" pane="">
                        <label class="layui-form-label">商品分类</label>
                        <div class="layui-input-block">
                            @{ List<ProductClassModel> proclass = ViewBag.proclass as List<ProductClassModel>;}
                            @foreach (var item in proclass.Where(m => m.ParentID == 0))
                            {
                                <input type="checkbox" name="ClassID" @Html.Raw(Model.ClassID.Any(m => m == item.ClassID) ? "checked=\"checked\"" : "") value="@item.ClassID" lay-filter="ProClass" lay-skin="primary" title="@item.ClassName">
                            }
                        </div>
                    </div>
                    <div class="layui-form-item" pane="">
                        <label class="layui-form-label">商品品牌</label>
                        <div class="layui-input-block" id="Brand">
                            @{ List<ProductClassModel> brand = ViewBag.brand as List<ProductClassModel>;}
                            @foreach (var item in brand)
                            {
                                <input type="checkbox" name="ClassID" data-pid="@item.ParentID" @Html.Raw(Model.ClassID.Any(m => m == item.ClassID) ? "checked=\"checked\"" : "") value="@item.ClassID" lay-skin="primary" title="@item.ClassName">
                            }
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">所在地址</label>
                        <div class="layui-input-block">
                            <div class="layui-inline">
                                <select id="Province" name="Province" lay-filter="Province"></select>
                            </div>
                            <div class="layui-inline">
                                <select id="City" name="City" lay-filter="City"></select>
                            </div>
                            <div class="layui-inline">
                                <select id="Area" name="Area"></select>
                            </div>
                            <div class="layui-inline">
                                @Html.TextBoxFor(m => m.Address, new { autocomplete = "off", @class = "layui-input" })
                            </div>
                        </div>
                    </div>

                    <div class="layui-form-item">
                        <label class="layui-form-label">合同照片</label>
                        <div class="layui-input-block">
                            <div class="layui-upload">
                                <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button>
                                <div class="layui-upload-list">
                                    <table class="layui-table">
                                        <thead>
                                            <tr>
                                                <th>文件名</th>
                                                <th>大小</th>
                                                <th>状态</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="demoList">
                                            @foreach (var item in Model.Photo.Split(','))
                                            {
                                                <tr>
                                                    <td><a href="@item" target="_blank">查看图片</a></td>
                                                    <td>
                                                        @{
                                                            FileInfo file = new FileInfo(Server.MapPath(item));
                                                        }
                                                        @Html.Raw(file.Length / 1024)K
                                                    </td>
                                                    <td>
                                                        已上传
                                                    </td>
                                                    <td>
                                                        <button data-path="@item" class="layui-btn layui-btn-xs layui-btn-danger file-delete" type="button">删除</button>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                                <button type="button" class="layui-btn" id="testListAction">开始上传</button>
                                @Html.HiddenFor(m => m.Photo)
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item layui-layout-admin">
                        <div class="layui-input-block">
                            <div class="layui-footer" style="left: 0;">
                                @Html.HiddenFor(m => m.SupplierID)
                                <button class="layui-btn" lay-submit="" lay-filter="component-form-demo1">立即提交</button>
                                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script src="~/Scripts/jquery-3.4.1.js"></script>
    <script src="~/LayUI/layuiAdmin/layuiadmin/layui/layui.js"></script>
    <script src="~/Scripts/PCASClass.js"></script>
    <script src="~/Scripts/Common.js"></script>
    <script>
        layui.config({
            base: '/LayUI/layuiAdmin/layuiadmin/' //静态资源所在路径
        }).extend({
            index: 'lib/index' //主入口模块
        }).use(['index', 'form', 'laydate', 'upload'], function () {
            //var $ = layui.$
            var admin = layui.admin
                , element = layui.element
                , layer = layui.layer
                , laydate = layui.laydate
                , form = layui.form
                , upload = layui.upload;

            form.render(null, 'component-form-group');


            //分类、品牌选择
            form.on('checkbox(ProClass)', function (data) {
                //console.log(data.elem); //得到checkbox原始DOM对象
                //console.log(data.elem.checked); //是否被选中，true或者false
                //console.log(data.value); //复选框value值，也可以通过data.elem.value得到
                //console.log(data.othis); //得到美化后的DOM对象

                if (data.elem.checked) {
                    //添加品牌
                    $.ajax({
                        url: "@Url.Action("GetBrand")",
                        type: "get",
                        dataType: "json",
                        data: { id: data.value},
                        success: function (d) {
                            d.forEach(function (v) {
                                var html = '<input type="checkbox" data-pid="' + data.value + '" name="ClassID" value="' + v.ClassID + '" lay-skin="primary" title="' + v.ClassName+'">';

                                $("#Brand").append(html);
                            })

                            form.render(); //更新全部
                        }
                    })
                } else {
                    console.log(data.value);
                    //删除品牌
                    $("[data-pid=" + data.value + "]").each(function () {
                        var obj = $(this).next();
                        obj.remove();
                        $(this).remove();
                        form.render(); //更新全部
                    })
                }
            });

            new PCAS("Province", "City", "Area", "@Model.Province", "@Model.City", "@Model.Area");
            form.render();
            form.on('select(Province)', function (data) {
                console.log(data.elem); //得到select原始DOM对象
                console.log(data.value); //得到被选中的值
                console.log(data.othis); //得到美化后的DOM对象
                new PCAS("Province", "City", "Area", data.value, "", "");
                form.render();
            });
            form.on('select(City)', function (data) {
                console.log(data.elem); //得到select原始DOM对象
                console.log(data.value); //得到被选中的值
                console.log(data.othis); //得到美化后的DOM对象
                new PCAS("Province", "City", "Area", data.value, data.value, "");
                form.render();
            });

            var files = [@Html.Raw(string.Join(",", Model.Photo.Split(',').Select(m => $"'{m}'")))];

            $(".file-delete").click(function () {
                var obj = $(this);                
                var path = obj.data("path");

                layer.confirm('确认要删除照片吗?', { icon: 3, title: '删除合同照片' }, function (index) {
                    //从服务器端删除照片
                    $.ajax({
                        url: "@Url.Action("DeletePhoto")",
                        type: "post",
                        dataType: "json",
                        data: { path: path},
                        success: function (d) {
                            layer.msg("删除成功", {
                                icon: 4,
                                time: 2000
                            }, function () {
                                //从数组去除项
                                files.remove(path);
                                //删除当前行
                                obj.parents("tr").remove();
                            });
                        }
                    })

                    layer.close(index);
                }, function (index) {
                    layer.close(index);
                });
            })

            //多文件列表示例
            var demoListView = $('#demoList')
                , uploadListIns = upload.render({
                    elem: '#testList'
                    , url: '@Url.Action("Upload")' //改成您自己的上传接口
                    , accept: 'file'
                    , multiple: true
                    , auto: false
                    , bindAction: '#testListAction'
                    , choose: function (obj) {
                        var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
                        //读取本地文件
                        obj.preview(function (index, file, result) {
                            var tr = $(['<tr id="upload-' + index + '">'
                                , '<td>' + file.name + '</td>'
                                , '<td>' + (file.size / 1024).toFixed(1) + 'kb</td>'
                                , '<td>等待上传</td>'
                                , '<td>'
                                , '<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
                                , '<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
                                , '</td>'
                                , '</tr>'].join(''));

                            //单个重传
                            tr.find('.demo-reload').on('click', function () {
                                obj.upload(index, file);
                            });

                            //删除
                            tr.find('.demo-delete').on('click', function () {
                                delete files[index]; //删除对应的文件
                                tr.remove();
                                uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
                            });

                            demoListView.append(tr);
                        });
                    }
                    , done: function (res, index, upload) {
                        if (res.data.src) { //上传成功
                            //上传图片的路径保存到数组
                            files.push(res.data.src);

                            var tr = demoListView.find('tr#upload-' + index)
                                , tds = tr.children();
                            tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
                            tds.eq(3).html(''); //清空操作
                            return delete this.files[index]; //删除文件队列已经上传成功的文件
                        }
                        this.error(index, upload);
                    }
                    , error: function (index, upload) {
                        var tr = demoListView.find('tr#upload-' + index)
                            , tds = tr.children();
                        tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
                        tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
                    }
                });


        /* 监听提交 */
            form.on('submit(component-form-demo1)', function (data) {

                $("#Photo").val(files.join());

                $.ajax({
                    url: "@Url.Action()",
                    type: "post",
                    dataType: "json",
                    data: $("form").serialize(),
                    success: function (d) {
                        if (d.code == 0) {
                            layer.msg('添加供应商成功', {
                                icon: 1,
                                time: 2000 //2秒关闭（如果不配置，默认是3秒）
                            }, function () {
                                //1、给用户选择：跳回列表页面还是停留在当前页面
                                //2、停留在当前页面
                                //$("form")[0].reset();
                                window.location.reload();
                            });
                        }
                    }
                })

                return false;
            });
        });
    </script>
</body>
</html>
